本ドキュメントは、LA-Bench 2025 コンペティションに向けた実験手順生成エージェントの開発要件とアーキテクチャをまとめたものです。これまでの検討内容（`gemini_thoughts.md`, `type-checker.md`, `workflow_consolidation.md`）を統合し、さらに「マテリアルと手順の間のギャップ」に対する解決策を盛り込んでいます。

## 1. プロジェクト概要

自然言語で記述された実験指示（Instruction）と使用物品（Mandatory Objects）から、再現性の高い詳細な実験手順（Procedure Steps）を生成するAIエージェントを開発します。

**コアコンセプト: "BioPlanner × Snakemake" 的なエージェントシステム**
単一のプロンプトで全てを生成するのではなく、実験を「オブジェクト（モノ）」と「オペレーション（操作）」の依存関係グラフ（DAG）としてモデル化し、論理的な整合性を担保してから自然言語の手順書に変換します。

---

## 2. 課題と解決策：マテリアルと手順のギャップ

### 課題 (The Gap)
入力データの `mandatory_objects` はあくまで「使用可能な道具やストック試薬のリスト（インベントリ）」に過ぎません。これらがあるからといって、自動的に「AとBを混ぜてCを作る」という具体的な操作フロー（A -> B -> C）が導き出されるわけではありません。
例えば、「酵素」と「バッファー」というマテリアル情報だけでは、「酵素をバッファーで何倍に希釈し、何本のチューブを用意するか」という**実験デザイン**の情報が欠落しています。

### 解決策 (The Solution): 「実験デザイン」レイヤーの導入
Phase 1（オブジェクト同定）において、単にモノをリストアップするのではなく、`instruction`（指示文）から**実験デザイン（Experimental Design）**を抽出するステップを明示的に組み込みます。

1.  **実験デザインの抽出**: 指示文を読み解き、「比較対象は何か」「N数はいくつか」「コントロール群はどうするか」「希釈系列はどうするか」といった論理的な構成（Sample Logic）を定義します。
2.  **論理サンプルの具体化**: 定義されたデザインに基づいて、必要な「中間生成物（チューブ、ウェル）」を具体的にインスタンス化します。

これにより、「道具リスト」→「実験デザイン」→「具体的なオブジェクト」→「操作フロー」という無理のない推論パスを構築します。

---

## 3. アーキテクチャ：3フェーズ思考プロセス

エージェントは以下の3つのフェーズを経て最終出力を生成します。

### Phase 1: Experimental Designer & Object Mapper
**目的**: 実験の論理構造を定義し、物理的な実体（ファイルパス）にマッピングする。

*   **Step 1.1: デザイン抽出**
    *   入力: `instruction`, `source_protocol_steps`
    *   思考: 「酵素濃度を変えた4条件 + コントロール2条件 = 計6サンプルが必要」といった実験計画を立てる。
*   **Step 1.2: オブジェクト定義**
    *   入力: `mandatory_objects`, Step 1.1のデザイン
    *   思考: デザインに基づき、初期リソース（`objects/initial/`）と、生成されるべき中間サンプル（`objects/intermediate/sample_1.tube` 等）を定義する。
    *   **重要**: ここで定義する中間オブジェクトは、後の操作の入出力のアンカーとなります。

### Phase 2: Operation Definer (DAG Construction)
**目的**: オブジェクト間の変換ルール（操作）を定義し、依存関係グラフを構築する。

*   **思考**: 「Sample 1を作るためには、Stock AとBuffer Bを混合する」という操作（Operation）を定義する。
*   **検証**: 定義された操作がつながり、全ての最終成果物（Final Objects）が生成可能か、DAGバリデータで検証する。

### Phase 3: Procedure Writer
**目的**: グラフ構造を人間可読な手順書に変換する。

*   **思考**: 依存関係順（トポロジカルソート）に操作を並べ、各操作を自然言語（日本語）の指示文に変換する。
*   **詳細化**: 具体的な液量、温度、時間、注意点（氷上操作など）を補完する。

---

## 4. ディレクトリ構成

現状のプロジェクト構成をベースに、エージェント開発に必要なフォルダ・ファイルを追加します。

```text
.
├── PROBLEM.md             # コンペティション概要
├── pyproject.toml         # Pythonプロジェクト設定
├── data/                  # 入力データ (example.jsonl, public_test.jsonl 等)
├── docs/                  # ドキュメント (本ファイル含む)
├── outputs/               # 生成結果の保存先
├── src/
│   ├── agents/            # エージェントロジック
│   │   ├── experiment_planner.py  # [New] メインエージェントクラス
│   │   └── dag_validator.py       # [Refactor] DAG検証ロジック
│   ├── prompts/           # プロンプトテンプレート (Jinja2)
│   │   ├── phase1_design_objects.jinja2  # [New] 実験デザイン・オブジェクト定義用
│   │   ├── phase2_operations.jinja2      # [New] 操作定義用
│   │   └── phase3_procedure.jinja2       # [New] 手順書生成用
│   ├── tools/             # 外部ツール
│   │   ├── web_fetcher.py # URL情報取得
│   │   └── dag_validator.py # (既存のものを整理・統合)
│   └── main.py            # [New] 実行エントリポイント
└── workspace/             # [New] エージェントの作業領域（中間ファイル）
    ├── 1_design_objects.json
    ├── 2_operations.json
    └── references/
```

---

## 5. 実装要件

### システム環境
*   **Engine**: Claude Code (または同等の推論能力を持つLLM)
*   **Mode**: 非対話モード (`-p`) でのバッチ実行を基本とする。

### 必須機能 (Tools)
1.  **Web Fetcher**: `references` に含まれるURLからプロトコルの詳細（バッファー組成、反応条件など）を取得し、知識を補完する機能。
2.  **DAG Validator**: Phase 2で生成されたJSONが、グラフとして成立しているか（未定義の入力がないか、循環していないか）をチェックするPythonスクリプト。

### 入出力データ
*   **Input**: `data/*.jsonl` (LA-Benchフォーマット)
*   **Output**: `procedure_steps` を含むJSONオブジェクト。

---

## 6. 今後のアクションアイテム

1.  **プロンプト作成**: 特にPhase 1の「実験デザイン抽出」を強化したプロンプトを設計する。
2.  **バリデータ移植**: 既存の `dag_validator.py` を本アーキテクチャに合わせて調整する。
3.  **パイプライン構築**: 3つのフェーズを連続して実行する `main.py` を実装する。